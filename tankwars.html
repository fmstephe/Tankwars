<html>
  <head>
	<script type="text/javascript">
	  var terrain;
	  var canvas;
	  var height;
	  var width;
	  var player1;
	  var player2;
	  
	  // Player Object
	  function player(x, name) {
		this.x = x;
		this.y = 0; // This gets set automatically by the physics
		this.name = name;
		this.arc = 0;
		this.power = 0;
	  }
	  function setPlayer(player) {
		player.y = terrain[player.x]
	  }	
	  function init() {
		canvas = document.getElementById("canvas");
		height = canvas.height;
		width = canvas.width;
		terrain = generateTerrain(canvas.width, canvas.height);
		player1 = new player(r(width/3),"Player1");
		setPlayer(player1);
		player2 = new player(width-r(width/3),"Player2");
		setPlayer(player2);
		render();
	  }
	  function render() {
		context = canvas.getContext("2d");
		context.fillStyle = "rgba(0,0,0,1.0)";
		context.fillRect(0,0,canvas.width,canvas.height);
		context.fillStyle = "rgba(100,100,100,1.0)";
		context.lineWidth = 5
		context.strokeStyle = "rgba(200, 200, 200, 0.3)";
		context.beginPath();
		context.moveTo(0, height);
		for (x = 0; x < terrain.length; x++) {
		  //console.log(terrain[x])
		  context.lineTo(x, height - terrain[x]);
		}
		context.lineTo(width,height);
		context.closePath();
		context.stroke();
		context.beginPath();
		context.moveTo(0,height);
		for (x = 0; x < terrain.length; x++) {
		  //console.log(terrain[x])
		  context.lineTo(x, height - terrain[x]);
		}
		context.lineTo(width,height);
		context.closePath();
		context.fill();
		context.beginPath();
		context.fillStyle = "rgba(255,30,40,1.0)";
		context.arc(player1.x, height-player1.y, 10, 0, 2*Math.PI, true);
		context.fill();
		context.closePath();
		context.arc(player2.x, height-player2.y, 10, 0, 2*Math.PI, true);
		context.fill();
		context.closePath();
	  }
	  function r(lim) {
		return Math.floor(Math.random()*lim)+1
	  }
	  function generateTerrain(width, height) {
		var wave = makeWave(width, width/r(10), width/r(2), height/r(5))
		for (var i = 0; i < 10; i++) {
		  var divisor = r(i)
		  var oWave = makeWave(width, width/r(10), width/(divisor*2.5), height/(divisor*5))
		  addWave(wave, oWave);
		}
		normaliseWave(wave, 700, 50)
		return wave
	  }
	  function makeWave(len, offset, waveWidth, waveHeight) {
		var wave = new Array(len)
		var widthMult = (Math.PI*2)/waveWidth
		for (i = 0; i < len; i++) {
		  x = (i+offset) * widthMult
		  y = Math.floor(Math.cos(x)*waveHeight)
		  wave[i] = y
		}
		return wave
	  }
	  function addWave(wave1, wave2) {
		for (i = 0; i < wave1.length; i++) {
		  wave1[i] = wave1[i]+wave2[i]
		}
	  }
	  function normaliseWave(wave, upperLim, lowerLim) {
		var max = wave[0];
		for (i = 0; i < wave.length; i++) {
		  if (wave[i] > max)
			max = wave[i];
		}
		var min = wave[0];
		for (i = 0; i < wave.length; i++) {
		  if (wave[i] < min)
			min = wave[i];
		}
		var outMagnitude = upperLim - lowerLim;
		for (i = 0; i < wave.length; i++) {
		  var inMagnitude = (wave[i]-min) / (max-min)
		  wave[i] = (inMagnitude * outMagnitude) + lowerLim
		}
	  }
	  function explode(e) {
		var radius = 100;
		var x = e.clientX;
		var y = height-e.clientY;
		var mult = (Math.PI/2)/radius;
		for (i = 0; i < radius; i++) {
		  var sub = radius*Math.cos(i*mult);
		  var bottom = y-sub;
		  if (x+i < width && bottom < terrain[x+i]) {
			console.log(i, "plus")
			terrain[x+i] -= Math.min(sub, terrain[x+i]-bottom)
		  }
		  if (x-i >= 0 && i != 0 && bottom < terrain[x-i]) {
			console.log(i, "minus")
			terrain[x-i] -= Math.min(sub, terrain[x-i]-bottom)
		  }
		}
		render();
		/*
		context.beginPath();
		context.arc(x, y, 50, 0, 2*Math.PI, true);
		context.fillStyle = "rgba(255,30,40,1.0)";
		context.fill()
		context.lineWidth = 5
		context.strokeStyle = "rgba(255, 255, 255, 0.8)";
		context.stroke();
		*/
	  }
	</script>
  </head>
  <body onload="init()">
	<div>
	  <canvas id="canvas" width="2400" height="800" border="2" onClick="explode(event)"></canvas>
	</div>
  </body>
</html>